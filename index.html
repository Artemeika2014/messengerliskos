<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ЛИСКОС 2025</title>
    <!-- Библиотека Supabase -->
    <script src="cdn.jsdelivr.net"></script>
    <style>
        :root { --accent: #6366f1; --bg: #020617; --glass: rgba(255, 255, 255, 0.03); --border: rgba(255, 255, 255, 0.1); --text: #f8fafc; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; transition: 0.2s; }
        body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        .screen { position: fixed; inset: 0; background: rgba(2, 6, 23, 0.98); backdrop-filter: blur(25px); z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .active-screen { display: flex !important; }
        .card { background: var(--glass); border: 1px solid var(--border); padding: 40px; border-radius: 32px; width: 90%; max-width: 420px; text-align: center; }
        .input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 12px; border: 1px solid var(--border); background: rgba(0,0,0,0.4); color: white; outline: none; }
        .btn { width: 100%; padding: 15px; border-radius: 12px; border: none; background: var(--accent); color: white; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .app { width: 95vw; height: 90vh; max-width: 1100px; background: var(--glass); border: 1px solid var(--border); border-radius: 28px; display: flex; overflow: hidden; }
        .sidebar { width: 300px; border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .msg { max-width: 75%; padding: 12px 18px; border-radius: 18px; margin-bottom: 5px; animation: pop 0.3s ease; }
        @keyframes pop { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .msg.own { align-self: flex-end; background: var(--accent); }
        .msg.other { align-self: flex-start; background: rgba(255,255,255,0.1); }
    </style>
</head>
<body>

    <div id="db-indicator" style="position:fixed; top:10px; right:10px; font-size:12px; color:red; z-index:1000;">СОЕДИНЕНИЕ...</div>

    <div id="sc-start" class="screen active-screen">
        <div class="card">
            <h1 style="font-size: 3.5rem; margin: 0; color: var(--accent); letter-spacing: -3px;">ЛИСКОС</h1>
            <p>будущие общения уже сдесь</p>
            <button id="b1" class="btn" onclick="showAuth('reg')" disabled>Создать профиль</button>
            <button id="b2" class="btn" onclick="showAuth('login')" style="background:none; border:1px solid var(--accent)" disabled>У меня есть аккаунт</button>
        </div>
    </div>

    <div id="sc-auth" class="screen">
        <div class="card">
            <h2 id="auth-title">Вход</h2>
            <input type="text" id="phone" class="input" placeholder="Телефон">
            <input type="password" id="pass" class="input" placeholder="Пароль">
            <div id="pin-box" style="display:none"><input type="text" id="pin-login" class="input" placeholder="ПИН" maxlength="4"></div>
            <button class="btn" onclick="step1()">Продолжить</button>
        </div>
    </div>

    <div id="sc-setup" class="screen">
        <div class="card">
            <div style="background:#fef9c3; color:#854d0e; padding:15px; border-radius:15px; font-weight:900; font-size:28px;">ПИН: <span id="gen-pin">0000</span></div>
            <img id="setup-ava" style="width:100px; height:100px; border-radius:30px; cursor:pointer; border:3px solid var(--accent); margin:15px 0;" src="" onclick="refreshAva()">
            <input type="text" id="f-name" class="input" placeholder="Ваше Имя">
            <input type="text" id="f-user" class="input" placeholder="@username">
            <button class="btn" onclick="finishReg()">Завершить</button>
        </div>
    </div>

    <div id="sc-app" class="app" style="display:none">
        <div class="sidebar"><div style="padding:20px; border-bottom: 1px solid var(--border);"><img id="my-ava" style="width:40px; border-radius:10px;" src=""><b id="my-name">...</b></div><div id="u-list"></div></div>
        <div style="flex:1; display:flex; flex-direction:column;"><div id="c-area" style="flex:1; padding:20px; overflow-y:auto; display:flex; flex-direction:column;"></div><div style="padding:20px; display:flex; gap:10px;"><input type="text" id="mi" class="input" style="margin:0"><button onclick="send()" class="btn" style="width:60px; margin:0">✈</button></div></div>
    </div>

    <script>
        var supabase, myData, activePhone, mode = 'login', tempPin, currentAva;

        const SB_URL = "https://jjwjqcwnxszujktzvjve.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impqd2pxY3dueHN6dWprdHp2anZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwNzE5NzMsImV4cCI6MjA4MTY0Nzk3M30.rhDX9wPSwDuMaW9OikbT8GE1YuqeOHvHcUYvQAgcnaY";

        function init() {
            if (window.supabase && window.supabase.createClient) {
                supabase = window.supabase.createClient(SB_URL, SB_KEY);
                document.getElementById('db-indicator').innerText = "ОНЛАЙН";
                document.getElementById('db-indicator').style.color = "green";
                document.getElementById('b1').disabled = false;
                document.getElementById('b2').disabled = false;
            } else { setTimeout(init, 500); }
        }
        init();

        function showAuth(m) {
            mode = m;
            document.getElementById('sc-start').classList.remove('active-screen');
            document.getElementById('sc-auth').classList.add('active-screen');
            document.getElementById('auth-title').innerText = m === 'reg' ? 'Регистрация' : 'Вход';
            document.getElementById('pin-box').style.display = m === 'reg' ? 'none' : 'block';
        }

        function refreshAva() {
            currentAva = `api.dicebear.com{Math.random()}`;
            document.getElementById('setup-ava').src = currentAva;
        }

        async function step1() {
            const phone = document.getElementById('phone').value.trim();
            const pass = document.getElementById('pass').value;
            if (mode === 'reg') {
                tempPin = Math.floor(1000 + Math.random() * 9000).toString();
                document.getElementById('gen-pin').innerText = tempPin;
                refreshAva();
                document.getElementById('sc-auth').classList.remove('active-screen');
                document.getElementById('sc-setup').classList.add('active-screen');
            } else {
                const pin = document.getElementById('pin-login').value;
                const { data, error } = await supabase.from('chat_users').select('*').eq('phone', phone).eq('password', pass).eq('secret_code', pin).single();
                if (error || !data) return alert("Ошибка!");
                myData = data; startApp();
            }
        }

        async function finishReg() {
            const phone = document.getElementById('phone').value.trim();
            const pass = document.getElementById('pass').value;
            const name = document.getElementById('f-name').value;
            const user = document.getElementById('f-user').value.replace('@','');
            const { error } = await supabase.from('chat_users').insert([{ phone, password: pass, secret_code: tempPin, full_name: name, username: user, avatar_url: currentAva }]);
            if (error) return alert(error.message);
            alert("Ваш ПИН: " + tempPin); location.reload();
        }

        async function startApp() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            document.getElementById('sc-app').style.display = 'flex';
            document.getElementById('my-name').innerText = myData.full_name;
            document.getElementById('my-ava').src = myData.avatar_url;
            const { data } = await supabase.from('chat_users').select('*').neq('phone', myData.phone);
            document.getElementById('u-list').innerHTML = data.map(u => `<div style="padding:15px; cursor:pointer;" onclick="openChat('${u.phone}','${u.full_name}')">${u.full_name}</div>`).join('');
            supabase.channel('m').on('postgres_changes', { event: 'INSERT', table: 'messages' }, () => load()).subscribe();
        }

        function openChat(p, n) { activePhone = p; load(); }
        async function load() {
            if (!activePhone) return;
            const { data } = await supabase.from('messages').select('*').or(`and(sender.eq.${myData.phone},receiver.eq.${activePhone}),and(sender.eq.${activePhone},receiver.eq.${myData.phone})`).order('created_at', { ascending: true });
            document.getElementById('c-area').innerHTML = (data || []).map(m => `<div class="msg ${m.sender === myData.phone ? 'own' : 'other'}">${m.content}</div>`).join('');
            document.getElementById('c-area').scrollTop = document.getElementById('c-area').scrollHeight;
        }

        async function send() {
            const mi = document.getElementById('mi');
            if (!mi.value || !activePhone) return;
            await supabase.from('messages').insert([{ sender: myData.phone, receiver: activePhone, content: mi.value }]);
            mi.value = ''; load();
        }
    </script>
</body>
</html>
